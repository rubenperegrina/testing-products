import { TestBed } from '@angular/core/testing';
import { HttpClientTestingModule, HttpTestingController } from '@angular/common/http/testing';

import { ProductsService } from './product.service';
import { Product } from '../models/product.model';
import { generateManyProducts, generateOneProduct } from '../models/product.mock';
import { environment } from './../../environments/environment';

fdescribe('ProductsService', () => {
    let productService: ProductsService;
    let httpController: HttpTestingController;

    beforeEach(() => {
        TestBed.configureTestingModule({
            imports: [HttpClientTestingModule],
            providers: [
                ProductsService
            ]
        });
        productService = TestBed.inject(ProductsService);
        httpController = TestBed.inject(HttpTestingController);
    });

    it('should be create', () => {
        expect(productService).toBeTruthy();
    });

    describe('tests for getAllSimple', () => {
        it('should return a product list', (doneFn) => {
            //Arrange
            const mockData: Product[] = generateManyProducts(2);
            //Act
            productService.getAllSimple()
                .subscribe((data) => {
                    //Assert
                    expect(data.length).toEqual(mockData.length);
                    expect(data).toEqual(mockData);
                    doneFn();
                });

            // http config
            const url = `${environment.API_URL}/api/v1/products`;
            const req = httpController.expectOne(url);
            req.flush(mockData);
            httpController.verify();
        });
    });

    describe('tests for getAll', () => {
        it('should return a product list', (doneFn) => {
            //Arrange
            const mockData: Product[] = generateManyProducts(3);
            //Act
            productService.getAll()
                .subscribe((data) => {
                    //Assert
                    expect(data.length).toEqual(mockData.length);
                    doneFn();
                });

            // http config
            const url = `${environment.API_URL}/api/v1/products`;
            const req = httpController.expectOne(url);
            req.flush(mockData);
            httpController.verify();
        });

        it('should return product list with taxes', (doneFn) => {
            // Arrange
            const mockData: Product[] = [
                {
                    ...generateOneProduct(),
                    price: 100, // 100 * .19 = 19
                },
                {
                    ...generateOneProduct(),
                    price: 200, // 200 * .19 = 38
                }
            ];
            //Act
            productService.getAll()
                .subscribe((data) => {
                    //Assert
                    expect(data.length).toEqual(mockData.length);
                    expect(data[0].taxes).toEqual(19);
                    expect(data[1].taxes).toEqual(38);
                    doneFn();
                });

            // http config
            const url = `${environment.API_URL}/api/v1/products`;
            const req = httpController.expectOne(url);
            req.flush(mockData);
            httpController.verify();
        });
    });

});